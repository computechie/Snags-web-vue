{"ast":null,"code":"import \"core-js/modules/es.error.cause.js\";\nlet timer; // for holding timer function for auto logout if session expire\n\nexport default {\n  async login(context, payload) {\n    return context.dispatch('auth', { ...payload\n    });\n  },\n\n  async auth(context, payload) {\n    const token = context.rootGetters.token; //User token !!\n\n    const baseUrl = localStorage.getItem('_rootRestUrl');\n    const response = await fetch(baseUrl + '/Authenthication/Login', {\n      method: 'POST',\n      body: JSON.stringify({\n        username: payload.username,\n        password: payload.password,\n        token: token\n      })\n    });\n    const responseData = await response.json();\n\n    if (!response.ok) {\n      // console.log(responseData);\n      const error = new Error(responseData.message || 'Failed to authenticate.');\n      throw error;\n    } //expecting in json recive 'exipresIn' in minutes! how long will session exists\n\n\n    const expiresIn = +responseData[0].expiresIn * 1000 * 60;\n    const expirationDate = new Date().getTime() + expiresIn; //auto logout if token expires\n\n    timer = setTimeout(function () {\n      context.dispatch('autoLogout');\n    }, expiresIn); //store login details in local storeage so that on refresh page app remember loged user!\n\n    localStorage.setItem('token', responseData[0].token);\n    localStorage.setItem('userId', responseData[0].userId);\n    localStorage.setItem('userFullname', responseData[0].userFullname);\n    localStorage.setItem('tokenExpiration', expirationDate);\n    localStorage.setItem('expiresIn', expiresIn);\n    context.commit('setUser', {\n      token: responseData[0].token,\n      userId: responseData[0].userId,\n      userFullname: responseData[0].userFullname\n    });\n  },\n\n  logout(context) {\n    localStorage.removeItem('token');\n    localStorage.removeItem('userId');\n    localStorage.removeItem('userFullname');\n    localStorage.removeItem('tokenExpiration');\n    localStorage.removeItem('expiresIn');\n    clearTimeout(timer);\n    context.commit('setUser', {\n      token: null,\n      userId: null,\n      userFullname: null,\n      tokenExpiration: null\n    });\n  },\n\n  //try to login if local storage containt login details\n  autoLogin(context) {\n    const token = localStorage.getItem('token');\n    const userId = localStorage.getItem('userId');\n    const userFullname = localStorage.getItem('userFullname');\n    const tokenExpiration = localStorage.getItem('tokenExpiration');\n    const willExpire = +tokenExpiration - new Date().getTime();\n    const expiresIn = localStorage.getItem('expiresIn');\n\n    if (willExpire < 0) {\n      //if token expires do nothing\n      return;\n    } //if is token ok then we must extend life of the token for the next expiration time\n\n\n    const expirationDate = new Date().getTime() + expiresIn;\n    localStorage.setItem('tokenExpiration', expirationDate); //set new timer\n\n    timer = setTimeout(function () {\n      context.dispatch('autoLogout');\n    }, expiresIn); //login \"again\" this user\n\n    if (token && userId && userFullname) {\n      context.commit('setUser', {\n        token: token,\n        userId: userId,\n        userFullname: userFullname\n      });\n    }\n  },\n\n  autoLogout(context) {\n    context.dispatch('logout');\n    context.commit('setAutoLogout');\n  }\n\n};","map":{"version":3,"names":["timer","login","context","payload","dispatch","auth","token","rootGetters","baseUrl","localStorage","getItem","response","fetch","method","body","JSON","stringify","username","password","responseData","json","ok","error","Error","message","expiresIn","expirationDate","Date","getTime","setTimeout","setItem","userId","userFullname","commit","logout","removeItem","clearTimeout","tokenExpiration","autoLogin","willExpire","autoLogout"],"sources":["Q:/Projects/DFM v2/src/store/modules/auth/actions.js"],"sourcesContent":["let timer; // for holding timer function for auto logout if session expire\r\n\r\n\r\n\r\n\r\nexport default {\r\n    \r\n\r\n\r\n    async login(context,payload) {\r\n          return  context.dispatch('auth',{\r\n                ...payload\r\n            });\r\n    }, \r\n    \r\n    async  auth(context,payload){\r\n        \r\n        const token = context.rootGetters.token; //User token !!\r\n\r\n        const baseUrl = localStorage.getItem('_rootRestUrl');\r\n\r\n        const response = await fetch(baseUrl+'/Authenthication/Login',{\r\n               method: 'POST',\r\n               body: JSON.stringify({\r\n                   username: payload.username,\r\n                   password: payload.password,\r\n                   token:token\r\n               })\r\n              \r\n   \r\n          });\r\n                 \r\n          const responseData = await response.json();\r\n   \r\n          if(!response.ok){\r\n              // console.log(responseData);\r\n               const error = new Error(responseData.message || 'Failed to authenticate.');\r\n               throw error;\r\n          }\r\n\r\n          //expecting in json recive 'exipresIn' in minutes! how long will session exists\r\n          const expiresIn = +responseData[0].expiresIn * 1000 * 60;\r\n          const expirationDate = new Date().getTime() +  expiresIn;\r\n   \r\n          //auto logout if token expires\r\n          timer = setTimeout(function(){\r\n            context.dispatch('autoLogout');\r\n          },expiresIn)\r\n\r\n          //store login details in local storeage so that on refresh page app remember loged user!\r\n          localStorage.setItem('token',responseData[0].token);\r\n          localStorage.setItem('userId',responseData[0].userId);\r\n          localStorage.setItem('userFullname',responseData[0].userFullname);\r\n          localStorage.setItem('tokenExpiration',expirationDate);\r\n          localStorage.setItem('expiresIn',expiresIn);\r\n\r\n          context.commit('setUser',{\r\n                  token: responseData[0].token,\r\n                  userId : responseData[0].userId,\r\n                  userFullname: responseData[0].userFullname\r\n                 \r\n   \r\n           });\r\n   \r\n    },\r\n    \r\n    logout(context){\r\n\r\n        localStorage.removeItem('token');\r\n        localStorage.removeItem('userId');\r\n        localStorage.removeItem('userFullname');\r\n        localStorage.removeItem('tokenExpiration'); \r\n        localStorage.removeItem('expiresIn'); \r\n        \r\n\r\n        clearTimeout(timer);\r\n\r\n        context.commit('setUser', {\r\n            token : null,\r\n            userId : null,\r\n            userFullname : null,\r\n            tokenExpiration : null\r\n        })\r\n\r\n        \r\n\r\n    },\r\n\r\n    //try to login if local storage containt login details\r\n    autoLogin(context){\r\n       \r\n        const token = localStorage.getItem('token');\r\n        const userId = localStorage.getItem('userId');\r\n        const userFullname = localStorage.getItem('userFullname');\r\n        const tokenExpiration = localStorage.getItem('tokenExpiration');\r\n        const willExpire = +tokenExpiration - new Date().getTime();\r\n        const expiresIn =localStorage.getItem('expiresIn');\r\n\r\n        if(willExpire < 0){\r\n            //if token expires do nothing\r\n            return;\r\n        }\r\n       \r\n        //if is token ok then we must extend life of the token for the next expiration time\r\n                            \r\n        const expirationDate = new Date().getTime() + expiresIn ;\r\n        localStorage.setItem('tokenExpiration',expirationDate);\r\n\r\n       \r\n        //set new timer\r\n        timer = setTimeout(function(){\r\n            context.dispatch('autoLogout');\r\n        }, expiresIn)\r\n\r\n        //login \"again\" this user\r\n        if (token && userId && userFullname){\r\n            context.commit('setUser',{\r\n                  token: token,\r\n                  userId : userId,\r\n                  userFullname: userFullname\r\n                  \r\n            });\r\n        }\r\n\r\n    },\r\n    autoLogout(context){\r\n        context.dispatch('logout');\r\n        context.commit('setAutoLogout');\r\n            \r\n   \r\n    }\r\n\r\n\r\n\r\n}"],"mappings":"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"},"metadata":{},"sourceType":"module"}