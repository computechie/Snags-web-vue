{"ast":null,"code":"import \"core-js/modules/es.error.cause.js\";\nlet timer; // for holding timer function for auto logout if session expire\n\nlet timerCountdown; // for holding timer function for auto logout if session expire\n\nexport default {\n  async login(context, payload) {\n    return context.dispatch(\"auth\", { ...payload\n    });\n  },\n\n  async auth(context, payload) {\n    //const token = context.rootGetters.token; //User token !!\n    const baseUrl = localStorage.getItem(\"_rootRestUrl\");\n    const response = await fetch(baseUrl + \"/api/v1/Auth/LogIn\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify({\n        email: payload.username,\n        password: payload.password,\n        sessionId: ''\n      })\n    });\n    /* if (response.status==404) {  \r\n        \r\n         alert(\"Wrong username or password!\");\r\n        // parent.isLoading = false;\r\n     }*/\n\n    if (response.status != 200) {\n      const responseData2 = await response.text(); // console.log(responseData);\n\n      const error = new Error(responseData2);\n      throw error;\n    }\n\n    const responseData = await response.json(); //expecting in json recive 'exipresIn' in minutes! how long will session exists\n    //const expiresIn = responseData.validFor * 1000 * 60;\n\n    const expiresIn = 60 * 1000 * 60;\n    const expiresInCountdown = 2000; //one minute before expire\n    //auto logout if token expires\n\n    timer = setTimeout(function () {\n      context.dispatch(\"autoLogout\");\n    }, expiresIn); //auto logout if token expires\n\n    timerCountdown = setTimeout(function () {\n      // context.dispatch(\"autoLogout\");\n      alert(\"expire soon\");\n    }, expiresInCountdown); //store login details in local storeage so that on refresh page app remember loged user!\n\n    localStorage.setItem(\"token\", responseData.sessionId);\n    localStorage.setItem(\"userId\", responseData.id);\n    localStorage.setItem(\"tokenExpiration\", responseData.expireDate);\n    localStorage.setItem(\"userFullname\", responseData.name + \" \" + responseData.surname);\n    localStorage.setItem(\"userType\", responseData.type);\n    localStorage.setItem(\"userLocale\", responseData.language); //data needed from login json:\n    //localStorage.setItem('userFullname',payload.username);\n\n    localStorage.setItem(\"expiresIn\", expiresIn);\n    context.commit(\"setUser\", {\n      token: responseData.sessionId,\n      userId: responseData.userId,\n      userFullname: responseData.name + \" \" + responseData.surname,\n      userType: responseData.type,\n      userLocale: responseData.language\n    });\n  },\n\n  async logout(context) {\n    const thistoken = localStorage.getItem(\"token\"); // needed for logout\n\n    localStorage.clear();\n    clearTimeout(timer);\n    clearTimeout(timerCountdown);\n    context.commit(\"setUser\", {\n      token: null,\n      userId: null,\n      userFullname: null,\n      userType: null,\n      userLocale: null,\n      tokenExpiration: null\n    }); //send logout request :\n\n    const baseUrl = localStorage.getItem(\"_rootRestUrl\");\n    await fetch(baseUrl + \"/api/v1/Auth/LogOut\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify({\n        email: '',\n        password: '',\n        sessionId: thistoken\n      })\n    }); // ------------\n\n    this.$router.push('/');\n  },\n\n  //try to login if local storage containt login details\n  autoLogin(context) {\n    const token = localStorage.getItem(\"token\");\n    const userId = localStorage.getItem(\"userId\");\n    const userFullname = localStorage.getItem(\"userFullname\");\n    const userType = localStorage.getItem(\"userType\");\n    const userLocale = localStorage.getItem(\"userLocale\");\n    const tokenExpiration = localStorage.getItem(\"tokenExpiration\");\n    const willExpire = +tokenExpiration - new Date().getTime();\n    const expiresIn = localStorage.getItem(\"expiresIn\");\n    const expiresInCountdown = 2000; //one minute before expire\n\n    if (willExpire < 0) {\n      //if token expires do nothing\n      return;\n    } // alert(\"token ok\")\n    //if is token ok then we must extend life of the token for the next expiration time\n\n\n    const expirationDate = new Date().getTime() + expiresIn;\n    localStorage.setItem(\"tokenExpiration\", expirationDate);\n    clearTimeout(timer);\n    clearTimeout(timerCountdown); //set new timer\n\n    timer = setTimeout(function () {\n      context.dispatch(\"autoLogout\");\n    }, expiresIn);\n    console.log('autologin'); //set new timer\n\n    timerCountdown = setTimeout(function () {\n      //  context.dispatch(\"autoLogout\");\n      alert(\"expire soon\");\n    }, expiresInCountdown);\n    console.log('autologin'); // ------------------------\n    //login \"again\" this user\n\n    if (token && userId && userFullname) {\n      context.commit(\"setUser\", {\n        token: token,\n        userId: userId,\n        userFullname: userFullname,\n        userType: userType,\n        userLocale: userLocale\n      });\n    }\n  },\n\n  autoLogout(context) {\n    context.dispatch(\"logout\");\n    context.commit(\"setAutoLogout\");\n    this.$router.push('/');\n  }\n\n};","map":{"version":3,"names":["timer","timerCountdown","login","context","payload","dispatch","auth","baseUrl","localStorage","getItem","response","fetch","method","headers","body","JSON","stringify","email","username","password","sessionId","status","responseData2","text","error","Error","responseData","json","expiresIn","expiresInCountdown","setTimeout","alert","setItem","id","expireDate","name","surname","type","language","commit","token","userId","userFullname","userType","userLocale","logout","thistoken","clear","clearTimeout","tokenExpiration","$router","push","autoLogin","willExpire","Date","getTime","expirationDate","console","log","autoLogout"],"sources":["Q:/Projects/Transport-web-/src/store/modules/auth/actions.js"],"sourcesContent":["let timer; // for holding timer function for auto logout if session expire\r\nlet timerCountdown; // for holding timer function for auto logout if session expire\r\n\r\n\r\nexport default {\r\n  async login(context, payload) {\r\n    return context.dispatch(\"auth\", {\r\n      ...payload,\r\n    });\r\n  },\r\n\r\n \r\n  async auth(context, payload) {\r\n    //const token = context.rootGetters.token; //User token !!\r\n \r\n    const baseUrl = localStorage.getItem(\"_rootRestUrl\");\r\n    const response = await fetch(baseUrl+\"/api/v1/Auth/LogIn\", {\r\n      method: \"POST\",\r\n\r\n      headers: {\r\n        \"Content-Type\":\"application/json\"\r\n      },\r\n      body: JSON.stringify({\r\n        email: payload.username,\r\n        password: payload.password,\r\n        sessionId: '',\r\n      }),\r\n    });\r\n\r\n   /* if (response.status==404) {  \r\n       \r\n        alert(\"Wrong username or password!\");\r\n       // parent.isLoading = false;\r\n    }*/\r\n    if (response.status!=200) {\r\n       const responseData2 = await response.text();\r\n\r\n        // console.log(responseData);\r\n        const error = new Error(\r\n            responseData2\r\n        );\r\n        throw error;\r\n      }\r\n\r\n\r\n\r\n    const responseData = await response.json();\r\n\r\n\r\n    //expecting in json recive 'exipresIn' in minutes! how long will session exists\r\n    //const expiresIn = responseData.validFor * 1000 * 60;\r\n   \r\n     const expiresIn = (60 * 1000) * 60 ;\r\n     const expiresInCountdown = 2000 ; //one minute before expire\r\n\r\n\r\n    //auto logout if token expires\r\n   timer = setTimeout(function () {\r\n      context.dispatch(\"autoLogout\");\r\n    }, expiresIn);\r\n\r\n    //auto logout if token expires\r\n    timerCountdown = setTimeout(function () {\r\n     // context.dispatch(\"autoLogout\");\r\n     alert(\"expire soon\")\r\n    }, expiresInCountdown);\r\n\r\n    //store login details in local storeage so that on refresh page app remember loged user!\r\n\r\n    localStorage.setItem(\"token\", responseData.sessionId);\r\n    localStorage.setItem(\"userId\", responseData.id);\r\n    localStorage.setItem(\"tokenExpiration\", responseData.expireDate);\r\n    localStorage.setItem(\"userFullname\",responseData.name+\" \"+responseData.surname);\r\n    localStorage.setItem(\"userType\",responseData.type);\r\n    localStorage.setItem(\"userLocale\",responseData.language);\r\n    //data needed from login json:\r\n\r\n    //localStorage.setItem('userFullname',payload.username);\r\n\r\n    localStorage.setItem(\"expiresIn\", expiresIn);\r\n\r\n    context.commit(\"setUser\", {\r\n      token: responseData.sessionId,\r\n      userId: responseData.userId,\r\n      userFullname: responseData.name+\" \"+responseData.surname,\r\n      userType: responseData.type,\r\n      userLocale: responseData.language\r\n    });\r\n  },\r\n\r\n  async logout(context) {\r\n    const thistoken = localStorage.getItem(\"token\"); // needed for logout\r\n   \r\n    localStorage.clear();\r\n    \r\n    \r\n    clearTimeout(timer);\r\n    clearTimeout(timerCountdown);\r\n\r\n    context.commit(\"setUser\", {\r\n      token: null,\r\n      userId: null,\r\n      userFullname: null,\r\n      userType: null,\r\n      userLocale: null,\r\n      tokenExpiration: null,\r\n    });\r\n\r\n    //send logout request :\r\n        const baseUrl = localStorage.getItem(\"_rootRestUrl\");\r\n       \r\n              \r\n    await    fetch(baseUrl+\"/api/v1/Auth/LogOut\", {\r\n          method: \"POST\",\r\n\r\n          headers: {\r\n            \"Content-Type\":\"application/json\"\r\n          },\r\n          body: JSON.stringify({\r\n            email: '',\r\n            password: '',\r\n            sessionId: thistoken,\r\n          }),\r\n        });\r\n\r\n\r\n        \r\n\r\n    // ------------\r\n    \r\n    this.$router.push('/'); \r\n\r\n\r\n  },\r\n\r\n  //try to login if local storage containt login details\r\n  autoLogin(context) {\r\n\r\n   \r\n    const token = localStorage.getItem(\"token\");\r\n    const userId = localStorage.getItem(\"userId\");\r\n    const userFullname = localStorage.getItem(\"userFullname\");\r\n    const userType = localStorage.getItem(\"userType\");\r\n    const userLocale = localStorage.getItem(\"userLocale\");\r\n    const tokenExpiration = localStorage.getItem(\"tokenExpiration\");\r\n    const willExpire = +tokenExpiration - new Date().getTime();\r\n    const expiresIn = localStorage.getItem(\"expiresIn\");\r\n    const expiresInCountdown = 2000 ; //one minute before expire\r\n   \r\n\r\n    if (willExpire < 0) {\r\n      //if token expires do nothing\r\n      return;\r\n    }\r\n\r\n   // alert(\"token ok\")\r\n\r\n    //if is token ok then we must extend life of the token for the next expiration time\r\n\r\n    const expirationDate = new Date().getTime() + expiresIn;\r\n    localStorage.setItem(\"tokenExpiration\", expirationDate);\r\n\r\n    clearTimeout(timer);\r\n    clearTimeout(timerCountdown);\r\n\r\n    //set new timer\r\n    timer = setTimeout(function () {\r\n      context.dispatch(\"autoLogout\");\r\n    }, expiresIn);\r\n    console.log('autologin')\r\n\r\n    //set new timer\r\n    timerCountdown = setTimeout(function () {\r\n    //  context.dispatch(\"autoLogout\");\r\n    alert(\"expire soon\")\r\n    }, expiresInCountdown);\r\n    console.log('autologin')\r\n\r\n\r\n    // ------------------------\r\n\r\n    //login \"again\" this user\r\n    if (token && userId && userFullname) {\r\n      context.commit(\"setUser\", {\r\n        token: token,\r\n        userId: userId,\r\n        userFullname: userFullname,\r\n        userType: userType,\r\n        userLocale: userLocale,\r\n      });\r\n    }\r\n  },\r\n  autoLogout(context) {\r\n    context.dispatch(\"logout\");\r\n    context.commit(\"setAutoLogout\");\r\n    this.$router.push('/');\r\n  },\r\n};\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}